openapi: 3.0.3
info:
  title: iWheb Authentication Service
  description: |
    Secure PHP-based authentication with Webling integration, session management, and API-key authorization.
    
    Features:
    - Webling API authentication
    - Email code delivery via SMTP
    - SMS code delivery via Seven.io (optional)
    - Pluggable validation providers (email, SMS)
    - 6-digit code sessions (30min default)
    - API key permissions with routes and rate limits
    - Session isolation per key
    - Delegated cross-app sessions
    - XChaCha20-Poly1305 encryption
    
    ## API Key Configuration
    
    API keys are configured exclusively in `config/.secrets.php` with comprehensive access control:
    
    ```php
    $API_KEYS = [
        'your-api-key' => [
            'name' => 'Application Name',
            'permissions' => ['user_info', 'user_token', 'user_id', 'user_group_info', 'delegate_session'],
            'routes' => ['POST:/login', 'POST:/validate/{session_id}', ...],
            'rate_limit' => ['window_seconds' => 60, 'max_requests' => 100]
        ]
    ];
    ```
    
    ## Available Permissions
    
    - `user_info`: Access to GET /user/{session_id}/info (user data from Webling)
    - `user_token`: Access to GET /user/{session_id}/token (encrypted user token)
    - `user_id`: Access to GET /user/{session_id}/id (decrypted Webling user ID)
    - `user_properties`: Access to POST /user/{session_id}/properties (selective user properties)
    - `delegate_session`: Access to POST /session/delegate/{session_id} (create delegated sessions)
    - `membergroup_info`: Access to GET /membergroup/{session_id}/{membergroup_id} (membergroup data)
    - `membergroup_check`: Access to GET /membergroup/{session_id}/{membergroup_name}/member/{user_id} (membership check)
    
    **Session Rotation**: All user endpoints (`/user/*`), membergroup endpoints (`/membergroup/*`), and delegate endpoint automatically
    create new sessions and invalidate old ones for enhanced security.
  version: 1.0.0
  contact:
    name: Digital Bastelbude Github
    url: https://github.com/Digital-Bastelbude/iwheb-auth

servers:
  - url: https://api.example.com
    description: Production server
  - url: http://localhost:8080
    description: Development server

security:
  - ApiKeyAuth: []

tags:
  - name: Authentication
    description: Login, validation, and logout operations
  - name: Session
    description: Session management (check, touch, delegate)
  - name: User
    description: User information and token retrieval
  - name: Membergroup
    description: Webling membergroup information and membership checks

paths:
  /login:
    post:
      tags:
        - Authentication
      summary: Initiate login with validation code
      description: |
        Creates a session and sends a 6-digit authentication code via the specified
        validation provider (email or SMS). The code is valid for 5 minutes by default.
        
        **User Identification:**
        - User is always identified by their email address in Webling
        - The `email` field is required for all login requests
        
        **Validation Providers:**
        - `email` (default): Sends code to the user's email address (from Webling `E-Mail` field)
        - `sms`: Sends code to the user's mobile phone (from Webling `Mobile` field)
        
        **Provider Selection:**
        - If `provider` is not specified, defaults to `email`
        - Provider automatically selects the appropriate field from user properties:
          - Email provider uses `E-Mail` field
          - SMS provider uses `Mobile` field
        - If provider cannot find required field, falls back to email provider
        
        **Session Management:** 
        - Deletes ALL existing user sessions across all API keys
        - Enforces "one session per user/API-key" policy
        - New session replaces any previous sessions for this user/API-key combination
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: byte
                  description: Base64-encoded email address (URL-safe) to identify the user in Webling. Always required.
                  example: dXNlckBleGFtcGxlLmNvbQ==
                provider:
                  type: string
                  enum: [email, sms]
                  description: Validation provider to use for sending the authentication code. Defaults to 'email' if not specified.
                  example: email
      responses:
        '200':
          description: Session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          $ref: '#/components/responses/InvalidInput'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/StorageError'

  /validate/{session_id}:
    post:
      tags:
        - Authentication
      summary: Validate authentication code
      description: |
        Validates the 6-digit code for a session. On success, the session is marked
        as validated and a new session ID is returned.
      operationId: validate
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - code
              properties:
                code:
                  type: string
                  pattern: '^\d{6}$'
                  description: 6-digit authentication code
                  example: "123456"
      responses:
        '200':
          description: Code validated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateResponse'
        '400':
          $ref: '#/components/responses/InvalidInput'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/StorageError'

  /session/check/{session_id}:
    get:
      tags:
        - Session
      summary: Check session status
      description: |
        Checks if a session is active and validated.
        Returns session expiry time if active.
      operationId: checkSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Session is active
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionCheckResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /session/touch/{session_id}:
    post:
      tags:
        - Session
      summary: Refresh session
      description: |
        Extends session expiry time and generates a new session ID.
        Returns the new session ID and expiration time.
      operationId: touchSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Session refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TouchSessionResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/StorageError'

  /session/delegate/{session_id}:
    post:
      tags:
        - Session
      summary: Create delegated session
      description: |
        Creates a pre-validated session for another API key. The delegated session
        is bound to the parent session's lifecycle. Requires `delegate_session` permission.
        
        **Session Rotation**: Creates a new session for the current API key and invalidates the old one.
        The delegated session becomes a child of the new session.
        Use the new `session_id` from the response for subsequent requests.
        
        **Session Management:**
        - Deletes any existing sessions for user + target API key combination
        - Enforces "one session per user/API-key" policy for delegated sessions
      operationId: createDelegatedSession
      parameters:
        - $ref: '#/components/parameters/SessionId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - target_api_key
              properties:
                target_api_key:
                  type: string
                  description: API key for the delegated session
                  example: app-key-2
      responses:
        '200':
          description: Delegated session created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DelegatedSessionResponse'
        '400':
          $ref: '#/components/responses/InvalidInput'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/StorageError'

  /session/logout/{session_id}:
    post:
      tags:
        - Authentication
      summary: Logout and delete all user sessions
      description: |
        Deletes ALL sessions for the user and API key combination.
        This ensures complete logout across all devices/sessions for this API key.
        
        **Session Management:**
        - Deletes all sessions matching user token + API key
        - Response includes count of deleted sessions
      operationId: logout
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: Session deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/{session_id}/info:
    get:
      tags:
        - User
      summary: Get user information
      description: |
        Retrieves user information from Webling for the authenticated user.
        Requires `user_info` permission.
        
        **Session Rotation**: Creates a new session and invalidates the old one.
        Use the new `session_id` from the response for subsequent requests.
      operationId: getUserInfo
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: User information retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfoResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/{session_id}/token:
    get:
      tags:
        - User
      summary: Get user token
      description: |
        Retrieves the encrypted user token for the authenticated user.
        Requires `user_token` permission.
        
        **Session Rotation**: Creates a new session and invalidates the old one.
        Use the new `session_id` from the response for subsequent requests.
      operationId: getUserToken
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: User token retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserTokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/{session_id}/id:
    get:
      tags:
        - User
      summary: Get user Webling ID
      description: |
        Retrieves the decrypted Webling user ID for the authenticated user.
        Requires `user_id` permission.
        
        **Session Rotation**: Creates a new session and invalidates the old one.
        Use the new `session_id` from the response for subsequent requests.
      operationId: getUserId
      parameters:
        - $ref: '#/components/parameters/SessionId'
      responses:
        '200':
          description: User ID retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserIdResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /user/{session_id}/properties:
    get:
      tags:
        - User
      summary: Get selective user properties
      description: |
        Retrieves specific user properties from Webling for the authenticated user.
        Requires `user_properties` permission.
        
        **Property Filtering**: Properties are filtered by:
        1. Properties requested in the query parameter
        2. Properties allowed for the API key (configured in `allowed_properties`)
        3. Properties that exist in the Webling user object
        
        If a requested property is not allowed or doesn't exist, it is silently omitted
        from the response (no error is thrown).
        
        **API Key Configuration**: Optionally restrict properties per API key:
        ```php
        'allowed_properties' => ['Vorname', 'Name', 'E-Mail']
        ```
        If `allowed_properties` is not configured, all requested properties are allowed.
        
        **Session Rotation**: Creates a new session and invalidates the old one.
        Use the new `session_id` from the response for subsequent requests.
      operationId: getUserProperties
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: properties
          in: query
          required: true
          schema:
            type: string
          description: Comma-separated list of property names to retrieve
          example: "Vorname,Name,E-Mail,Telefon 1"
      responses:
        '200':
          description: User properties retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPropertiesResponse'
        '400':
          $ref: '#/components/responses/InvalidInput'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /membergroup/{session_id}/{membergroup_id}:
    get:
      tags:
        - Membergroup
      summary: Get membergroup information
      description: |
        Retrieves membergroup data from Webling including subgroups and member user IDs.
        Requires `membergroup_info` permission.
        
        **Session Rotation**: Creates a new session and invalidates the old one.
        Use the new `session_id` from the response for subsequent requests.
      operationId: getMembergroup
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: membergroup_id
          in: path
          required: true
          schema:
            type: integer
          description: Webling membergroup ID
          example: 123
      responses:
        '200':
          description: Membergroup data retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MembergroupResponse'
        '400':
          $ref: '#/components/responses/InvalidInput'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

  /membergroup/{session_id}/{membergroup_name}/member:
    get:
      tags:
        - Membergroup
      summary: Check membergroup membership
      description: |
        Checks if the authenticated user (from the session) is a member of a membergroup in Webling.
        Requires `membergroup_check` permission.
        
        **Session Rotation**: Creates a new session and invalidates the old one.
        Use the new `session_id` from the response for subsequent requests.
      operationId: checkMembership
      parameters:
        - $ref: '#/components/parameters/SessionId'
        - name: membergroup_name
          in: path
          required: true
          schema:
            type: string
          description: Webling membergroup name
          example: "Vorstand"
      responses:
        '200':
          description: Membership check completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MembershipCheckResponse'
        '400':
          $ref: '#/components/responses/InvalidInput'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: |
        API key for authentication. Can also be provided via `Authorization: ApiKey <key>` header.

  parameters:
    SessionId:
      name: session_id
      in: path
      required: true
      schema:
        type: string
        pattern: '^[a-zA-Z0-9]+$'
      description: Session identifier
      example: abc123def456

  schemas:
    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: Session identifier
              example: abc123def456
            code_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when code expires
              example: "2025-10-31T12:35:00Z"
            session_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when session expires
              example: "2025-10-31T13:00:00Z"

    ValidateResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier (rotated)
              example: def456ghi789
            validated:
              type: boolean
              example: true
            session_expires_at:
              type: string
              format: date-time
              example: "2025-10-31T13:00:00Z"

    SessionCheckResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              example: abc123def456
            expires_at:
              type: string
              format: date-time
              example: "2025-10-31T13:00:00Z"
            active:
              type: boolean
              example: true

    TouchSessionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier (rotated)
              example: ghi789jkl012
            expires_at:
              type: string
              format: date-time
              example: "2025-10-31T13:30:00Z"

    DelegatedSessionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier for current API key
              example: pqr567stu890
            expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when new session expires
              example: "2025-10-31T13:00:00Z"
            delegated_session:
              type: object
              description: Information about the created delegated session
              properties:
                session_id:
                  type: string
                  description: Delegated session identifier for target API key
                  example: xyz789abc012
                expires_at:
                  type: string
                  format: date-time
                  description: ISO 8601 timestamp when delegated session expires
                  example: "2025-10-31T13:00:00Z"
                validated:
                  type: boolean
                  example: true
                  description: Delegated sessions are pre-validated
                api_key:
                  type: string
                  description: Target API key for delegated session
                  example: app-key-2

    UserInfoResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier
              example: abc456def789
            user:
              type: object
              description: User information from Webling
              additionalProperties: true
            session_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when session expires
              example: "2025-10-31T13:05:00Z"

    UserTokenResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier
              example: def789ghi012
            token:
              type: string
              description: Encrypted user token
              example: dGVzdF90b2tlbl8xMjM0NTY=
            session_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when session expires
              example: "2025-10-31T13:05:00Z"

    UserIdResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier
              example: jkl345mno678
            user_id:
              type: string
              description: Decrypted Webling user ID
              example: "542"
            session_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when session expires
              example: "2025-10-31T13:05:00Z"

    UserPropertiesResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier
              example: mno789pqr012
            properties:
              type: object
              description: Filtered user properties from Webling
              additionalProperties:
                type: string
              example:
                Vorname: "Max"
                Name: "Mustermann"
                E-Mail: "max.mustermann@example.com"
            session_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when session expires
              example: "2025-10-31T13:05:00Z"

    MembergroupResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier
              example: stu456vwx789
            membergroup:
              type: object
              description: Membergroup data from Webling
              properties:
                id:
                  type: integer
                  description: Membergroup ID
                  example: 123
                type:
                  type: string
                  description: Object type
                  example: "membergroup"
                properties:
                  type: object
                  description: Membergroup properties
                  additionalProperties: true
                parents:
                  type: array
                  description: Parent membergroup IDs
                  items:
                    type: integer
                  example: []
                children:
                  type: array
                  description: Child membergroup IDs (subgroups)
                  items:
                    type: integer
                  example: [124, 125]
                links:
                  type: object
                  description: Related object links
                  properties:
                    member:
                      type: array
                      description: Member user IDs
                      items:
                        type: integer
                      example: [456, 457, 458]
            session_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when session expires
              example: "2025-10-31T13:05:00Z"

    MembershipCheckResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            session_id:
              type: string
              description: New session identifier
              example: yza012bcd345
            is_member:
              type: boolean
              description: Whether the user is a member of the membergroup
              example: true
            session_expires_at:
              type: string
              format: date-time
              description: ISO 8601 timestamp when session expires
              example: "2025-10-31T13:05:00Z"

    SuccessResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            message:
              type: string
              example: Session deleted successfully

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          description: Error code
          example: INVALID_INPUT
        message:
          type: string
          description: Human-readable error message
          example: Email required

  responses:
    InvalidInput:
      description: Invalid input parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: INVALID_INPUT
            message: Invalid input parameters

    Unauthorized:
      description: Unauthorized - Missing or invalid API key
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: UNAUTHORIZED
            message: Invalid or missing API key

    Forbidden:
      description: Forbidden - API key lacks required permission
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: FORBIDDEN
            message: Permission denied

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: NOT_FOUND
            message: Session not found or expired

    StorageError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            success: false
            error: STORAGE_ERROR
            message: Database operation failed
